<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css">
		<style>
			.box .layui-form-item {
				padding-left: 15px;
				color: #666
			}
		</style>
	</head>

	<body>

		<div class="layui-field-box" style="background:#fff">
			<fieldset class="layui-elem-field">
				<legend>交易信息：</legend>
				<div class="layui-form box" style="padding-top:20px" id="info_pay">
					<div class="layui-form-item">订单状态：<span class="layui-btn layui-btn-xs layui-btn-radius layui-btn-danger">等待付款</span></div>
					<div class="layui-form-item">竞拍类型：线上竞拍</div>
					<div class="layui-form-item">订单编号：201802124859673</div>
					<div class="layui-form-item">订单创建时间：2018/01/25 12:32:00</div>
				</div>
			</fieldset>

			<fieldset class="layui-elem-field ">
				<legend>支付信息：</legend>
				<table class="layui-table" lay-skin="nob" style="width:470px;float:left">
					<tbody id="info_goPay">

					</tbody>
				</table>
				<table class="layui-table" lay-skin="nob" style="width:auto;float:left;margin-top:68px">
					<tbody>
						<tr>
							<td>支付凭证：</td>
						</tr>
						<tr id="payWay">
							<td><img style="max-width:200px" src="images/u1627.png" alt="图片一" /></td>
						</tr>
					</tbody>
				</table>
			</fieldset>

			<fieldset class="layui-elem-field">
				<legend>车辆信息：</legend>
				<div class="layui-form box" style="padding-top:20px" id="car_list">
					<div class="layui-form-item">所属店铺：成都博恩</div>
					<div class="layui-form-item">车辆标题：2008款 本田 锋范 1.5L 自动精英版</div>
					<div class="layui-form-item">车架号：LNDW687549D</div>
					<div class="layui-form-item">车辆编号：346733</div>
				</div>
			</fieldset>

			<fieldset class="layui-elem-field">
				<legend>买家信息：</legend>
				<div class="layui-form box" style="padding-top:20px" id="role_buy">
					<div class="layui-form-item">买家姓名：刘文芳</div>
					<div class="layui-form-item">联系方式：15102345678</div>
					<div class="layui-form-item">身份证：4456745795225678232</div>
					<div class="layui-form-item">迁往地：北京</div>
				</div>
			</fieldset>

			<fieldset class="layui-elem-field">
				<legend>争议信息：</legend>
				<table>
					<tbody id="dispute_list">
						

					</tbody>
				</table>
			</fieldset>

			<!--付款确认-->
			<fieldset class="layui-elem-field" id="pay_hide">
				<legend>付款确认：</legend>
				<div class="layui-form" style="padding-top:10px">
					<div class="layui-form-item">
						<label class="layui-form-label"><b>实付总额：</b></label>
						<div class="layui-form-mid layui-word-aux" id="payAmount">

						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label"><b>付款凭证：</b></label>
						<div class="layui-upload"><button type="button" class="layui-btn" id="upload"><i class="layui-icon">&#xe67c;</i>上传凭证</button></div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label"><b>支付方式：</b></label>
						<div class="layui-input-block">
							<input name="bank" value="1" title="现金" type="radio">
							<input name="bank" value="2" title="银行卡" type="radio">
							<input name="bank" value="3" title="支付宝" type="radio">
							<input name="bank" value="4" title="微信" type="radio">
							<input name="bank" value="5" title="其他" type="radio">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label"><b>备注：</b></label>
						<div class="layui-input-block" style="width:400px"><textarea id="remark" class="layui-textarea"></textarea></div>
					</div>
					<div class="layui-form-item">
						<div class="layui-input-block">
							<button id="upCase" class="layui-btn" lay-submit="" lay-filter="save">确认</button>
							<button class="layui-btn layui-btn-primary">取消</button>
						</div>
					</div>
				</div>
			</fieldset>

			<fieldset class="layui-elem-field">
				<legend>订单轨迹：</legend>
				<ul class="layui-field-box layui-timeline" style="margin:10px 0 0 20px" id="order_cycle">
					<li class="layui-timeline-item">
						<i class="layui-icon layui-timeline-axis">&#xe63f;</i>
						<div class="layui-timeline-content layui-text">
							<h3 class="layui-timeline-title">交易完成</h3>
							<p>2018-01-15 14:00:00</p>
						</div>
					</li>
					<li class="layui-timeline-item">
						<i class="layui-icon layui-timeline-axis">&#xe63f;</i>
						<div class="layui-timeline-content layui-text">
							<h3 class="layui-timeline-title">代办审核已通过 （审核意见：同意）</h3>
							<p>2018-01-15 14:00:00</p>
						</div>
					</li>
					<li class="layui-timeline-item">
						<i class="layui-icon layui-timeline-axis">&#xe63f;</i>
						<div class="layui-timeline-content layui-text">
							<h3 class="layui-timeline-title">代办完结</h3>
							<p>2018-01-15 14:00:00</p>
						</div>
					</li>
					<li class="layui-timeline-item">
						<i class="layui-icon layui-timeline-axis">&#xe63f;</i>
						<div class="layui-timeline-content layui-text">
							<h3 class="layui-timeline-title">付款信息审核已通过 （审核意见：同意）</h3>
							<p>2018-01-15 14:00:00</p>
						</div>
					</li>
					<li class="layui-timeline-item">
						<i class="layui-icon layui-timeline-axis">&#xe63f;</i>
						<div class="layui-timeline-content layui-text">
							<h3 class="layui-timeline-title">已支付全部车款，待审核付款信息</h3>
							<p>2018-01-15 14:00:00</p>
						</div>
					</li>
					<li class="layui-timeline-item">
						<i class="layui-icon layui-timeline-axis">&#xe63f;</i>
						<div class="layui-timeline-content layui-text">
							<h3 class="layui-timeline-title">竞价成功，等待付款</h3>
							<p>2018-01-15 14:00:00</p>
						</div>
					</li>
				</ul>
			</fieldset>
		</div>

		<script type="text/javascript" src="plugins/layui/layui.all.js"></script>
		<script type="text/javascript" src="js/common/common_sup.js"></script>
		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
		<script>
			var on_uri;
			layui.use('table', function() {
				var upload = layui.upload;
				upload.render({
					elem: '#upload',
					url: base_url + '/boss/localeAuction/uploadImage',

					before: function(obj) {
						layer.load();
					},
					done: function(res) {
						if(res.resultCode != 100) {
							alert("图片上传失败请重试");

							return;
						}
						on_uri = res.data.url;
						layer.msg("图片加载成功！");
						
						layer.closeAll('loading');
					},
					error: function(res) {
						alert(JSON.stringify(res));
						layer.closeAll('loading');
					}
				});

			});
			$(function() {
				
				var result = getUrlParam();
				if(result==null||result.orderId==undefined||result.orderId==""||result.orderId==null){
					window.close();
				}
				
				init_pay(result.orderId);
				
				init_initiat(result.orderId);
				init_cycle(result.orderId);
				if(result.money == undefined || result.money == null || result.money == "") {
					
					$("#pay_hide").html("");
				} else {
					init_operation(result.orderId, result.breachId, result.money);
				}

			});

			function init_pay(orderId) {
				var uri = '/boss/order/selectOrderDetailById';
				var result = sup_ajax(uri, {
					"id": orderId
				}, false);
				if(result == null || result == "") {
					layer.msg("网络异常");
					return;
				}
				if(result.resultCode != 100) {
					layer.msg(result.resultMsg);
					return;
				}
				var name = ["status", "auctionType", "orderNo", "createTime"];
				var html = '';

				for(var j = 0; j < name.length; j++) {
					
					var tmp = eval('result.data.' + name[j]);
					if(tmp != null) {

						switch(name[j]) {
							case "status":
								var a_tmp = tmp;
								switch(a_tmp) {
									case '1':
										a_tmp = '等待付款';
										break;
									case '2':
										a_tmp = '付款信息待审核';
										break;
									case '3':
										a_tmp = '过户处理中';
										break;
									case '4':
										a_tmp = '争议处理中';
										break;
									case '5':
										a_tmp = '违约金支付确认中';
										break;
									case '6':
										a_tmp = '手续回传待确认';
										break;
									case '7':
										a_tmp = '交易完成';
										break;
									case '8':
										a_tmp = '交易关闭';
										break;

								}
								tmp = '<div class="layui-form-item">订单状态：<span class="layui-btn layui-btn-xs layui-btn-radius layui-btn-danger">';
								tmp += a_tmp;
								tmp += '</span></div>';
								break;
							case "auctionType":
								var a_tmp = tmp;
								if(a_tmp == '1') {
									a_tmp = "线上";
								} else if(a_tmp == "2") {
									a_tmp = "线下";
								}
								tmp = '<div class="layui-form-item">竞拍类型：';
								tmp += a_tmp;
								tmp += '</div>';
								break;
							case "orderNo":
								var a_tmp = tmp;
								tmp = ' <div class="layui-form-item">订单编号：';
								tmp += a_tmp;
								tmp += '</div>';
								break;
							case "createTime":
								var a_tmp = tmp;
								tmp = ' <div class="layui-form-item">订单创建时间：';

								tmp += timeFormat(a_tmp);
								tmp += '</div>';
								break;

						}
						html += tmp;
					}

				}
				var name2 = ["transactionFee", "serviceFee", "agentFee", "amountFee", "payFee", "payWay", "payNo", "payTime"];
				$("#info_pay").html(html);
				html = "";
				for(var j = 0; j < name2.length; j++) {
					var tmp = eval('result.data.' + name2[j]);
					console.log(name2[j] + ': ' + tmp);
					html += '<tr>';
					html += '<td>';

					if(tmp != null) {

						switch(name2[j]) {

							case "payFee":
								tmp = '实付总金额：<b style="color:orange">' + tmp + '元</b>';

								break;
							case 'payWay':
								switch(tmp) {
									case '1':
										tmp = '支付方式：现金';
										break;
									case '2':
										tmp = '支付方式：银行卡';
										break;
									case '3':
										tmp = '支付方式：微信';
										break;
									case '4':
										tmp = '支付方式：支付宝';
										break;
									case '5':
										tmp = '支付方式：其他';
										break;
								}
								break;
							case 'payTime':
								tmp = '支付时间：' + timeFormat(tmp);
								break;
							case 'transactionFee':
								tmp = '成交价：' + tmp + '元';
								break;
							case 'serviceFee':
								tmp = '服务费：' + tmp + '元';
								break;
							case 'agentFee':
								tmp = '代办费：' + tmp + '元';
								break;
							case 'amountFee':
								tmp = '应付总金额：' + tmp + '元';
								break;
							case 'payNo':
								tmp = '支付流水号：' + tmp;
								break;
						}
						html += tmp;
					}
					html += '</td>';
					html += '</tr>';

				}
				$("#info_goPay").html(html);
				/*添加支付凭证图片*/
				if(result.data.payEvidence != undefined&&result.data.payEvidence !=null&&result.data.payEvidence !="") {
					html = '<td><a target="_blank" href="' + result.data.payEvidence + '"><img style="max-width:200px" src="' + result.data.payEvidence + '" alt="图片一"/></a></td>';
					$("#payWay").html(html);
				}
				/*car_list*/
				html = "";
				name = ["storeName", "autoInfoName", "vin", "carAutoNo"];
				for(var j = 0; j < name.length; j++) {
					var tmp = eval('result.data.' + name[j]);
					if(tmp != null) {
						switch(name[j]) {
							case "storeName":
								tmp = '<div class="layui-form-item">所属店铺：' + tmp + '</div>';
								break;
							case "autoInfoName":
								tmp = '<div class="layui-form-item">车辆标题：' + tmp + '</div>';
								break;
							case "vin":
								tmp = '  <div class="layui-form-item">车架号：' + tmp + '</div>';
								break;
							case "carAutoNo":
								tmp = ' <div class="layui-form-item">车辆编号：' + tmp + '</div>';
								break;
							default:
								break;
						}
						html += tmp;
					}
				}
				$("#car_list").html(html);
				/*买家信息*/
				html = '';
				name = ["userName", "mobile", "identityNumber", "moveAddress"];
				for(var j = 0; j < name.length; j++) {
					var tmp = eval('result.data.' + name[j]);
					if(tmp != null) {
						switch(name[j]) {
							case "userName":
								tmp = '<div class="layui-form-item">买家姓名：' + tmp + '</div>';
								break;
							case "mobile":
								tmp = '<div class="layui-form-item">联系方式：' + tmp + '</div>';
								break;
							case "identityNumber":
								tmp = '  <div class="layui-form-item">身份证：' + tmp + '</div>';
								break;
							case "moveAddress":
								tmp = ' <div class="layui-form-item">迁往地：' + tmp + '</div>';
								break;
							default:
								break;
						}
						html += tmp;
					}
				}
				$("#role_buy").html(html);

			}

			function init_initiat(orderId) { //争议信息

				var uri = '/boss/order/selectOrderBreach';

				var result = sup_ajax(uri, {
					"orderId": orderId
				}, false);
				if(result == null || result == "") {
					layer.msg("网络异常");
					return;
				}
				if(result.resultCode != 100) {
					layer.msg(result.resultMsg);
					return;
				}
				var html = "";

				var name = ["initiatCn", "breachObjType", "initiatAuthName", "initiatAuthMsg",
					"initiatMobile", "initiatMsg",
					"initiatTime", "initiatAuthTime"
				]
				var mp_name = ["争议发起人：", "争议类型：", "争议审核人：", "争议结果：",
					"联系方式：", "争议原因：",
					"发起时间：", "审核时间"
				];

				
					var ans=0;
					for(var j = 0; j < name.length; j++) {
						if(name[j] == 'initiatCn' || name[j] == 'initiatMobile' || name[j] == 'initiatTime') {
							html += '<tr>';
						}
						var tmp = eval('result.data.' + name[j]);
						if(tmp==null){
							ans++;
						}
						switch(name[j]) {
							case 'initiatCn':
								html += '<td width="206" >' + mp_name[j]
								if(tmp != null) {
									html += tmp;
								}
								html += '</td>';

								break;
							case 'breachObjType':
								html += '<td width="200" >' + mp_name[j]
								if(tmp != null) {
									html += tmp;
								}
								html += '</td>';
								break;
							case 'initiatAuthName':
								html += '<td width="240" >' + mp_name[j]
								if(tmp != null) {
									html += tmp;
								}
								html += '</td>';
								break;
							case 'initiatAuthMsg':
								html += '<td rowspan="3">'+mp_name[j];
								if(tmp != null) {
									html += tmp;
								}
								html += '</td>';
								break;
							case 'initiatMobile':
								html += '<td>'+mp_name[j];
								if(tmp != null) {
									html += tmp;
								}
								html += '</td>';
								break;
							case 'initiatMsg':
								html += '<td>'+mp_name[j];
								if(tmp != null) {
									html += tmp;
								}
								html += '</td>';
								html += '<td>';
								html += '</td>';
								break;
							case 'initiatTime':
								html += '<td>'+mp_name[j];
								if(tmp != null) {
									html += timeFormat(tmp);
								}
								html += '</td>';
								html += '<td>';
								html += '</td>';
								break;
							case 'initiatAuthTime':
								html += '<td>'+mp_name[j];
								if(tmp != null) {
									html += timeFormat(tmp);
								}
								html += '</td>';
								break;
						}
					}
					if(name[j] == 'initiatAuthMsg' || name[j] == 'initiatMsg' || name[j] == 'initiatAuthTime') {
						html += '</tr>';
					}
				
				if(ans==name.length){
					html="";
				}
				$("#dispute_list").html(html);
			}

			function init_cycle(orderId) {
				var uri = '/boss/order/selectOrderLogList';
				var result = sup_ajax(uri, {
					"orderId": orderId
				}, false);
				if(result == null || result == "") {
					layer.msg("网络异常");
					return;
				}
				if(result.resultCode != 100) {
					layer.msg(result.resultMsg);
					return;
				}
				var html = "";
				for(var i = 0; i < result.data.length; i++) {
					if(result.data[i].logMsg == null || result.data[i].logMsg == "") {
						continue;
					}
					html += '<li class="layui-timeline-item"><i class="layui-icon layui-timeline-axis">&#xe63f;</i><div class="layui-timeline-content layui-text">';
					html += '<h3 class="layui-timeline-title">';
					html += result.data[i].statusCn;
					html += '</h3>';
					html+='<h4 class="layui-timeline-title">';
					html +='备注信息：'+result.data[i].logMsg;
					html+='</h4>';
					html += '<p>'
					html += timeFormat(result.data[i].createTime);
					html += '</p>'
					html += '	</div></li>';
				}
				$("#order_cycle").html(html);
			}

			function init_operation(orderId, breachId, money) {
				var uri = '/boss/carOrder/saveBreachOrderPay';
				
				var amount_pay = '<b style="color:orange;font-size:18px;padding-right:20px">';
				amount_pay += money + '元</b>请仔细核对买家实际支付的总金额是否正确';
				on_uri=null;
				
				

				$("#payAmount").html(amount_pay);

				$("#upCase").off('click'); //解绑 
				$("#upCase").on('click', function() {
					var payWay = $("input[name='bank']:checked").val();
					var payFee = money;
					var remark = $("#remark").val().trim();
					var payEvidence = on_uri;
					var data = {
						"orderId": orderId,
						"breachId": breachId,
						"payFee": payFee,
						"payEvidence": payEvidence,
						"payWay": payWay,
						"remark": remark

					};
					var result = sup_ajax('/boss/order/saveBreachOrderPay', data, false);
					if(result == null || result == "") {
						layer.msg("网络连接失败！请检查您的网络环境");
						return;
					}
					layer.msg(result.resultMsg);
					if(result.resultCode != 100) {
						return;
					}
					window.location="order-penalty.html";
				});
			}

			function getUrlParam() {
				var arr = window.location.search.slice(1).split('&');
				var obj = {};
				for(var i = 0; i < arr.length; i++) {
					var arr1 = arr[i].split('=');
					obj[arr1[0]] = arr1[1];
				}
				return obj;
			}
		</script>

	</body>

</html>