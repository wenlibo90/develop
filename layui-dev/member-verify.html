<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css">
	</head>

	<body class="layui-field-box">
          <div class="layui-field-box">
              <div class="layui-input-inline"><input placeholder="输入姓名/手机号" class="layui-input" type="text" id="member-input"></div>
              <div class="layui-btn js-search" data-type="reload"><i class="fa fa-search"></i>搜索</div>
              <div class="layui-btn" id="reviewed-all" data-type="getCheckData"><i class="fa fa-align-justify"></i>&nbsp;批量审核</div>
          </div>
          <div class="layui-field-box">
              <table class="layui-table">
                  <thead>
                      <tr>
                          <th>选择</th>
                          <th>会员姓名</th>
                          <th>注册手机号</th>
                          <th>所在城市</th>
                          <th>通讯地址</th>
                          <th>所属店铺</th>
                          <th>身份证号</th>
                          <th>详细信息</th>
                          <th>认证状态</th>
                          <th>认证提交时间</th>
                          <th>操作</th>
                      </tr>
                  </thead>
                  
                  <tbody id="tb_search">
                       
                  </tbody>
              </table>
          </div>

	</body>
    
    <!--审核-->
    <div id="member-th" lay-filter="pop-form" style="padding:30px 40px 0 0;display:none">
        <div class="layui-form-item layui-form">
            <label class="layui-form-label">审核结果</label>
            <div class="layui-input-block">
                <input  name="sex" value="2" title="同意" checked="" type="radio">
                <input  name="sex" value="-1" title="不同意" type="radio">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">审核意见</label>
            <div class="layui-input-block" style="width:200px"><textarea class="layui-textarea" id="text" maxlength="40"></textarea></div>
        </div>
    </div>
    
    <script type="text/javascript" src="plugins/layui/layui.all.js"></script>
    <script type="text/javascript" src="js/common/common_sup.js"></script>
    <script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
  	<script>
  		var page=1;
    	var limit=10;
  		function init(name)
    	{
    		var data ={
    			"searchName":name,
    			"page":page,
    			"limit":limit
    		};
    		var uri_search = "/boss/customerAuth/getUserAuthList";
    		var result_all_search =  sup_ajax(uri_search,data,false);
    		
    		if(result_all_search==null||result_all_search==""||result_all_search.resultCode!=100||result_all_search.data.count==0){
    			$("#tb_search").html('<td colspan="10" style="text-align:center;height:200px">没有数据！</td>');
    			return;
    		}
    		
    		
    		var map_search =["realName","mobile","cityName","address","userStoreName","identityNumber","userId",
    		"authStatus","applyTime"];
    		
    		var html="";
    		for(var i=0;i<result_all_search.data.list.length;i++){
    		    html+="<tr>";
    		   	html +="<td><input value=\"" + result_all_search.data.list[i].userId+ "\" lay-skin=\"primary\" type=\"checkbox\" name=\"mycheck\"/></td>";
    		    for(var j=0;j<map_search.length;j++){
    		    	html+='<td>';
    		    	if(map_search[j]=='authStatus'){
    		    			
    		    		switch(result_all_search.data.list[i].authStatus){
    		    		
    		    			case '1':
    		    				
    		    				html+="未通过审核";
    		    				break;
    		    			case '2':
    		    				html+="审核通过";
    		    				break;
    		    		}
    		    	}
    		    	else if(map_search[j]=="userId")
    		    	{
    		    		html+='<a class="layui-btn layui-btn-primary layui-btn-sm" onclick="gphoto('+result_all_search.data.list[i].id+')">查看</a>';
    		    	}
    		    	else if(map_search[j]=="applyTime"){
    		    		if(eval('result_all_search.data.list[i].'+map_search[j])!=null)
    		    		html+=timeFormat(eval('result_all_search.data.list[i].'+map_search[j]));
    		    	}
    		    	else
    		    	{
    		    		if(eval('result_all_search.data.list[i].'+map_search[j])!=null)
    		    		html+=eval('result_all_search.data.list[i].'+map_search[j]);
    		    	}
    		    	
    		    	html+='</td>';
    		    }
    		    html+='<td onclick="check_id('+result_all_search.data.list[i].userId+')"><a href="javascript:;" class="layui-btn layui-btn-warm layui-btn-sm">审核</a></td>';
    		    html+="</tr>";
    		};
    		
    		$("#tb_search").html(html);
    		
    		
    	}
    	
  		function check_id(id)
    	{
    		layui.use('table', function(){
    			var table = layui.table,form = layui.form
		,$= layui.jquery;
			layer.open({
				  title: '会员审核',
				  type: 1,
				  content: $('#member-th'),
				  btn: ['确定', '取消'],
				  shade: false,
				  success: function(){
					  form.render(null,'pop-form');
				  },
				  cancel:function(index)
				  { 
				  	$("#member-th").hide();
					   	layer.close(index);
				  },
				  yes: function(index){
					  //确定以后回调函数
					   var agree = $("input[name='sex']:checked").val();
					   var textA = $("#text").val();
					   if(textA.trim()==""||textA==null)
					   {
					   	layer.msg("请认真填写审批意见！");
					   }
					   else
					   {
					   	var data = {
					   	"userId":id,
					   	"authStatus":agree,
					   	"authMsg":textA
					   };
					   var uri = "/boss/customerAuth/approveUserAuth";
					   var result = sup_ajax(uri,data,false);
					   if(result.resultCode==100){
					   	layer.msg("提交审核成功");
					   	$("#member-th").hide();
					   	layer.close(index);
					   	init();
					   }
					   else
					   {
					   	layer.msg("审核提交失败，请重试");
					   }
					   }
					   
					  
				  },
				  btn2: function() {
						$("#member-th").hide();
					}
			  });
			  
			}); 
    	};
  	</script>
  <script>
	layui.use('table', function(){
		var table = layui.table,form = layui.form
		,$= layui.jquery;
		
		$(function(){
    		init();
    	});
    	
    	
		
		//事件监听
	
		
		/*批量审核*/
		$('#reviewed-all').on('click', function(){
			var box_checked = $("input[name='mycheck']:checked"); /*选中条数*/
						var id_str = ""; 
						box_checked.each(function() {
								
								id_str += $(this).attr('value') + ",";
							})
						
							/*这里讲复选框的内容做成以逗号分隔的字符串  不以逗号结尾*/
							
						if(id_str!=null&&id_str!=""){
							
						id_str = id_str.substring(0, id_str.length - 1);
						}
						else
						{
							
							layer.msg("请勾选需要审核的内容！");
							return;
						}
		 	layer.open({
				  title: '会员审核',
				  type: 1,
				  content: $('#member-th'),
				  btn: ['确定', '取消'],
				  shade: false,
				  success: function(){
					  form.render(null,'pop-form');
				  },
				  cancel:function(index)
				  { 
				  	$("#member-th").hide();
					   	layer.close(index);
				  },
				  yes: function(index){
					  //确定以后回调函数
					 
					  
					  
						
					  
					   
					   var agree = $("input[name='sex']:checked").val();
					   var textA = $("#text").val();
					   if(textA.trim()==""||textA==null)
					   {
					   	layer.msg("请认真填写审批意见！");
					   }
					   else
					   {
					   	var data = {
					   	"userId":id_str,
					   	"authStatus":agree,
					   	"authMsg":textA
					   };
					   var uri = "/boss/customerAuth/approveUserAuth";
					   var result = sup_ajax(uri,data,false);
					   if(result.resultCode==100){
					   	init();
					   	$("#member-th").hide();
					   	layer.close(index);
					   	layer.msg("提交成功");
					   }
					   else
					   {
					   	layer.msg("提交失败，请重试");
					   }
					   }
					   
					  
				  },
				  btn2: function() {
						$("#member-th").hide();
					}
			  });
		});
		
		/*搜索*/
		$('.js-search').on('click', function(){
			var temp = $("#member-input").val();
			init(temp);
		});
		
		active = {
			//搜索重载
			reload: function(){
			  var demoReload = $('#member-input');
			  table.reload('idTest',{
				page: {
				  curr: 1 //重新从第 1 页开始
				}
				,where: {
					id: demoReload.val()
				}
			  });
			},
			//数据选择
			getCheckData: function(){
				var checkStatus = table.checkStatus('idTest'),
				data = checkStatus.data;
				if(data.length!=0){
					parent.layer.confirm('确定批量审核通过？',{btn:['确认','取消']},function(index){
						parent.layer.close(index);
						//确认以后调用审核接口
						info = JSON.stringify(data); 
						//执行重载
						table.reload('idTest',{
							page: {
							  curr: 1 //重新从第 1 页开始
							},where: { 	
								id:JSON.stringify(data)
							}
						});
					});
				 }else{
					  parent.layer.alert('请选择数据'); 
				 }
			}
		};
		
	});
	function gphoto(id)
	{
		
		var data ={
			"authId":id	
		};
		var uri_photo = "/boss/customerAuth/getUserAuthById";
		var result = sup_ajax(uri_photo,data,false);
		var identityPhotoFront = result.data.identityPhotoFront;
		var identityPhotoHand = result.data.identityPhotoHand;
		var identityPhotoBack = result.data.identityPhotoBack;
		var img_data = {
  			"title": "用户身份信息", //相册标题
  			"id": 09103271, //相册id
  			"start": 0, //初始显示的图片序号，默认0
  			"data": [   //相册包含的图片，数组格式
   				 {
      				  "alt": "身份证正面照片",
     				 "pid": 6663, //图片id
      				"src": identityPhotoFront, //原图地址
      				"thumb": identityPhotoFront //缩略图地址  
   				 },
   				 {
      				  "alt": "手持照片",
     				 "pid": 6662, //图片id
      				"src": identityPhotoHand, //原图地址
     				 "thumb": identityPhotoHand //缩略图地址
   				 },
   				 {
      				  "alt": "身份证背面",
     				 "pid": 6661, //图片id
      				"src": identityPhotoBack, //原图地址
     				 "thumb": identityPhotoBack //缩略图地址
   				 }
  					]
						};
		layer.photos({
    	photos: img_data //格式见API文档手册页
    	,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机
    	,shade:false
    	,closeBtn:1
  		});
	}
	</script>

</html>