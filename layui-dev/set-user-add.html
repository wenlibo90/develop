<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title></title>
<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
<link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css">
</head>

<body style="background:#fff">

    <div class="layui-form" style="margin:30px 0 0 20px">
        <div class="layui-form-item">
            <label class="layui-form-label">用户姓名：</label>
            <div class="layui-input-inline" id="fuserName">
            <input id="userName" lay-verify="required" placeholder="请输入用户姓名" lay-verType="tips" class="layui-input" type="text">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">登录账号：</label>
            <div class="layui-input-inline" id="fuserKey">
                <input id="userKey" lay-verify="required" placeholder="请输入账号" lay-verType="tips" class="layui-input" type="text">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号：</label>
            <div class="layui-input-inline" id="fuserPhone"><input id="userPhone" maxlength="11" lay-verify="required|phone" placeholder="请输入手机号码" lay-verType="tips" class="layui-input" type="text"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密码：</label>
            <div class="layui-input-inline" id="fuserPassword"><input id="userPassword" lay-verify="required" placeholder="请输入密码" lay-verType="tips" class="layui-input" type="password"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">确认密码：</label>
            <div class="layui-input-inline" id="fpassWordAgain"><input id="passWordAgain" lay-verify="required" placeholder="再次确认密码" lay-verType="tips" class="layui-input" type="password"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">角色类型：</label>
            <div class="layui-input-block">
                <div class="layui-input-inline" style="width:80px">
                    <select lay-verify="required" id="role_type" lay-filter="role">
                    
                    </select>
                </div>
                <div class="layui-input-inline" style="width:320px">
                    <select lay-verify="required" id="role_shop">
                        <option value=""></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">角色名称：</label>
            <div class="layui-input-block">
                <div class="layui-input-inline">
                    <select lay-verify="required" id="role_name">
                        <option value=""></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">备注：</label>
            <div class="layui-input-inline" style="width:400px" id="fremark"><textarea lay-verify="required" lay-verType="tips" id="remark" class="layui-textarea"></textarea></div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="save">保存</button>
                <!--<button class="layui-btn layui-btn-primary">取消</button>-->
            </div>
        </div>
    </div>

</body>
<script type="text/javascript" src="js/md5.js"></script>
<script type="text/javascript" src="plugins/layui/layui.all.js"></script>
<script type="text/javascript" src="js/common/common_sup.js"></script>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script>
layui.use('form', function() {
	var form = layui.form,layer = layui.layer;
	$(function() {
		
		getUserById();
		
	});
	
	function getUserById(id) { //由当前Id获取一条信息并渲染
		var html = "";
		var role_name;
		var role_list;
		/*初始化下拉框*/
		var uri_role = '/boss/managerRole/selectAllRole';
		var result_role = sup_ajax(uri_role, {}, true);
		if(!check_str(result_role, 'result')) {
			layer.msg("服务器连接失败，请检查您的网络配置");
			return;
		}
		/*填充角色类型*/
		 var role_obj = 'role_name={';
		 var role_obj2 =  'role_list={';
		for(var i = 0; i < result_role.data.length; i++) {
			role_obj += 'role' + result_role.data[i].id + ':' + 'null';
			role_obj2 += 'role' + result_role.data[i].id + ':' + 'null';
			if(i < result_role.data.length-1) {
				role_obj += ',';
				role_obj2 += ',';
			}
		}
		role_obj += '}';
		role_obj2+='}';
		eval(role_obj);
		eval(role_obj2);
		for(var i = 0; i < result_role.data.length; i++) {
			html += '<option value="' + result_role.data[i].id + '">' + result_role.data[i].typeName + '</option>';
			var temp_html = '';
			var temp_html2 = ''; 
			for(var j = 0; j < result_role.data[i].roleList.length; j++) {
				temp_html += '<option value="' + result_role.data[i].roleList[j].id + '">' + result_role.data[i].roleList[j].roleName + '</option>';
				
			}
			
			for(var j = 0; j < result_role.data[i].storeVoList.length; j++) {
				temp_html2 += '<option value="' + result_role.data[i].storeVoList[j].id + '">' + result_role.data[i].storeVoList[j].name + '</option>';
			}
			if(i == 0) { //预先加载一次
				$("#role_name").html(temp_html);
				
				$("#role_shop").html(temp_html2);
			}
			var tx = 'role_name.'+'role'+result_role.data[i].id+'='+'temp_html';
			var tx2 = 'role_list.'+'role'+result_role.data[i].id+'='+'temp_html2';
			eval(tx);
			eval(tx2);
		}
		$("#role_type").html(html);
		
		/*初始化text输入框的内容*/
		var textNamed = ["userName", "userKey", "userPhone", "userPassword", "passWordAgain", "remark"];
		if(id == null) {
	
			for(var i = 0; i < textNamed.length; i++) {
				$("#" + textNamed).val("");
			}
		} else {
			var uri_getUser = '/boss/managerUser/selectManagerUser';
			var result_user = sup_ajax(uri_getUser, {
				"id": id
			}, false);
			if(!check_str(result_user, 'result')) {
				layer.msg("服务器连接失败，请检查您的网络配置");
				return;
			}
			for(var i = 0; i < textNamed.length; i++) {
				if(eval('result_user.data.' + textNamed[i]) != null) {
					
					$("#" + textNamed[i]).val(eval('result_user.data.' + textNamed[i]));
					continue;
				}
				$("#" + textNamed[i]).val("");
			}
		}
		
		
		if(id == null) {
			form.on('submit(save)', function(data){
				/*获取参数的值*/
				if($('#userPassword').val()!=$("#passWordAgain").val()){
					layer.msg("两次密码输入不一致");
					return;
				}
				var data={
					'userName':$("#userName").val(),
					'userKey':$("#userKey").val(),
					'userPhone':$("#userPhone").val(),
					'userPassword':hex_md5($('#userPassword').val()),
					'roleTypeId':$("#role_type").val(),
					'roleId':$("#role_name").val(),
					'departmentId':$("#role_shop").val(),
					'remark':$('#remark').val()
				};
				var uri_upLoad = '/boss/managerUser/saveManagerUser';
				var result = sup_ajax(uri_upLoad,data,false);
				if(result==null||result==""){
					layer.msg("网络异常，请稍后再试");
					return;
				}
				if(result.resultCode==100){
					var index = parent.layer.getFrameIndex(window.name);
					parent.layer.close(index)
                    parent.location.href="set-user.html";
				}else{
					layer.msg(result.resultMsg);
				}
			})//新增提交
		} else {
			$("#save").on('click', function() {
				var uri_save = '/boss/managerUser/updateManagerUser';
				if($('#userPassword').val()!=$("#passWordAgain").val()){
					layer.msg("两次密码输入不一致");
					return;
				}
				var data={
					'userName':$("#userName").val(),
					'userKey':$("#userKey").val(),
					'userPhone':$("#userPhone").val(),
					'userPassword':hex_md5($('#userPassword').val()),
					'roleTypeId':$("#role_type").val(),
					'roleId':$("#role_name").val(),
					'departmentId':$("#role_shop").val(),
					'id':id,
					'remark':$('#remark').val()
				};
				
				var result = sup_ajax(uri_save,data,false);
				if(result==null||result==""){
					layer.msg("网络异常，请稍后再试");
					return;
				}
				if(result.resultCode==100){
					
				}else{
					layer.msg(result.resultMsg);
				}
			}); //修改提交
		}
		form.on('select(role)', function(){
			var val_type_id = $("#role_type").val();
			$("#role_name").html(eval('role_name.' + "role" + val_type_id));
			$("#role_shop").html(eval('role_list.' + "role" + val_type_id));
			form.render();
		});
		form.render();
		/*readonly*/
		if(id!=null){
			$("#userKey").attr('readonly','readonly');
			
		}
	}
});
</script>

</html>