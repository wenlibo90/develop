<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="plugins/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="plugins/font-awesome/css/font-awesome.min.css">
	</head>

	<body>

		<div class="layui-field-box" id="form-sub">
			<div class="layui-field-box">
				<div class="layui-input-inline"><input name="id" placeholder="输入会员级别名称" class="layui-input" type="text" id="member-input" /></div>
				<div class="layui-btn js-search" data-type="reload" id="soso"><i class="fa fa-search"></i>&nbsp;搜索

				</div>
				<div class="layui-btn" id="add-level"><i class="layui-icon">&#xe608;</i>&nbsp;新增级别</div>
			</div>

			<div class="layui-field-box">
				<table class="layui-table">
					<thead>
						<tr>
							<th>会员级别编号</th>
							<th>会员级别名称</th>
							<th>缴纳保证金</th>
							<th>竞拍加价金额</th>
							<th>是否默认</th>
							<th>是否启用</th>
							<th>创建时间</th>
							<th>创建人</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody id="member_tbody">

					</tbody>
				</table>
			</div>
		</div>

		<!--级别设置-->
		<div class="layui-field-box layui-form" id="level-set" lay-filter="pop-form" style="padding:30px 40px 0 0;display: none;">

			<div class="layui-form-item">
				<label class="layui-form-label">级别名称：</label>
				<div class="layui-input-inline"><input class="layui-input" placeholder="会员级别名称" type="text" id="levelName"></div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label">是否启用：</label>
				<div class="layui-input-inline"><select class="layui-input" id="isOpen"><option value="1">是</option><option value="2">否</option></select></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">保证金：</label>
				<div class="layui-input-inline"><input class="layui-input" placeholder="填写缴纳保证金金额（元）" type="text" id="depositMoney"></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">竞拍加价：</label>
				<div class="layui-input-inline" id="lab_pr">

				</div>
			</div>
		</div>

		<div class="layui-field-box layui-form" id="level-set" lay-filter="pop-form" style="padding:30px 40px 0 0;display: none;">

			<div class="layui-form-item">
				<label class="layui-form-label">级别名称：</label>
				<div class="layui-input-inline"><input class="layui-input" placeholder="会员级别名称" type="text" id="levelName"></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">是否启用：</label>
				<div class="layui-input-inline"><select class="layui-input" id="isOpen"><option value="1">是</option><option value="2">否</option></select></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">保证金：</label>
				<div class="layui-input-inline"><input class="layui-input" placeholder="填写缴纳保证金金额（元）" type="text" id="depositMoney"></div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">竞拍加价：</label>
				<div class="layui-input-inline" id="lab_pr">

				</div>
			</div>
		</div>

	</body>

	<script type="text/javascript" src="plugins/layui/layui.all.js"></script>
	<script type="text/javascript" src="js/common/common_sup.js"></script>
	<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>

	<script type="text/javascript">
		
		/*---------分页配置参数--------*/
		var page_limit = 10; /*分页每页显示条数*/
		var page_start = 1; /*起始页*/
		/*---------映射表------------*/
		var or_name = [
			"id", "levelName", "depositMoney", "farePrice",
			"isDefault","isOpen", "createTime", "createPersonName"
		]; /*原始总览表头  名称与接口规则一致 由于接口不规范  会出现大写*/
		var up_table = ["levelName", "isOpen", "depositMoney", "farePrice"]; /*原始修改表头*/
		/*原始表格前缀修饰对象*/
		var pre_modify = {
			"id": '编号',
			"levelName": null,
			"depositMoney": null,
			"farePrice": null,
			"isOpen": null,
			"createTime": null,
			"createPersonName": null,
			"isDefault":null
		};
		//原始表格后缀修饰对象
		var aft_modify = {
			"id": null,
			"levelName": null,
			"depositMoney": {
				way: "normal",
				value: "元"
			},
			"farePrice": null,
			"isOpen": null,
			"createTime": null,
			"createPersonName": null,
			"isDefault":null
		};
		/*渲染语句*/
		var yeah_cls = "<a href=\"javascript:;\" class=\"layui-btn layui-btn-primary layui-btn-xs\" id=\"sequence\">是</a>";
		var not_cls = '<a href="javascript:;" class="layui-btn layui-btn-disabled layui-btn-xs" id="sequence">否</a>';
		
		//值修饰对象
		var mid_modify = {
			"code": null,
			"levelName": null,
			"depositMoney": null,
			"farePrice": {
				way: "split_prefix",
				value: {
					"sp": ",",
					"pr": "元"
				}
			},
			"isOpen": {
				way: "replace",
				value: [yeah_cls, not_cls]
			},
			"createTime": {
				way: "const_st",
				value: "timestamp"
			},
			"createPersonName": null,
			"isDefault":{
				way: "replace",
				value: [yeah_cls, not_cls]
			}
		};
		/*----------------html页面内函数----------------*/
		$(function() {
			init_table(); /*初始化表单数据*/
			init_lab(); /*初始化标签卡信息*/
		});
		/*-----------------外部初始化函数----------------------*/
		function init_table(lev_name) { /*主表格初始化*/
			var url = "/boss/level/getCustomerLevelList";
			var data = {
				levelName: lev_name,
				page: page_start,
				limit: page_limit
			};
			var result = sup_ajax(url,data,false);
			var html;
			/*如果没有返回值*/
			if (result == null) {
				$("#member_tbody").html('<tr><td colspan="9" style="text-align:center;height:200px">服务异常，没有数据！</td></tr>');
			} else {
				var html = "";
				var count = Number.parseInt(JSON.stringify(result.data.count));
				for (var i = 0; i < count; i++) { /*解析字符串进行对象遍历*/
					html += "<tr>";
					for (var j = 0; j < or_name.length; j++) {
						html += "<td>";
						var ms = "result.data.list[i]."; /*创建指令*/
						ms += or_name[j]; /*指令完成*/
						if (eval(ms) != null) {
							html += modif(or_name[j], "pre", null); /*选择相应的前缀进行添加*/
							html += modif(or_name[j], "middle", eval(ms)); /*使用eval动态获取参数*/
							html += modif(or_name[j], "aft", null); /*选择相应的后缀进行添加*/
						}
						html += "</td>";
					}
					var temp_id = eval("result.data.list[i].id");
					html += "<td><a href=\"javascript:;\" class=\"layui-btn layui-btn-sm\" " +
						"id=\"modify\" onclick=\"up_id(" + temp_id + ")\">修改</a>" +
						"<a href=\"javascript:;\" class=\"layui-btn layui-btn-sm\" onclick=\"del_lev(" + temp_id +
						")\">删除</a></td>";
					html += "</td>";
					html += "</tr>";
				}
				var tboy = $("#member_tbody");
				tboy.html(html);
			}
		}

		function init_lab() { /*小标签初始化*/
			/*清空表格*/
			for (var j = 0; j < up_table.length - 1; j++) {
				$("#" + up_table[j]).val("");
			}
			var url = "/boss/fareSetting/selectAllFare";
			var data = {};
			var result = sup_ajax(url, data, true);
			if (result == null || result == "" || result.resultCode != 100) {
				/*在接口调用失败的情况下  不对其进行  填入操作*/
				return;
			}
			var len = result.data.length;
			var html = "";
			for (var i = 0; i < len; i++) {
				html += "<input value=\"" + result.data[i].id + "\" title=\"" + result.data[i].farePrice + "\" lay-skin=\"primary\" type=\"checkbox\" name=\"price_checkbox\"/>";
			}
			$("#lab_pr").html(html);
		}
		/*-----------------表格数据修饰相关函数----------------------*/
		function modif(modify_name, modify_type, val_in) { /*表格前后缀修饰*/
			var fix = "";
			switch (modify_type) {
				case "pre":
					/*前缀*/
					fix += "pre_modify." + modify_name;
					if (eval(fix) != null) {
						var temp_fix = fix + ".value";
						if (eval(temp_fix) != null) {
							temp_fix = fix + ".way";
							if (eval(temp_fix) != null) {
								switch (eval(temp_fix)) {
									case "normal":
										temp = fix + ".value";
										return (eval(temp));
										break;
								}
							}
						}
					}
					break;
				case "aft":
					/*后缀*/
					fix += "aft_modify." + modify_name;
					if (eval(fix) != null) {
						var temp_fix = fix + ".value";
						if (eval(temp_fix) != null) {
							temp_fix = fix + ".way";
							if (eval(temp_fix) != null) {
								switch (eval(temp_fix)) {
									case "normal":
										temp = fix + ".value";
										return (eval(temp));
										break;
								}
							}
						}
					}
					break;
				case "middle":
					/*中间值*/
					fix += "mid_modify." + modify_name;
					if (eval(fix) != null) {
						var temp_fix = fix + ".value";
						if (eval(temp_fix) != null) {
							temp_fix = fix + ".way";
							if (eval(temp_fix) != null) {
								switch (eval(temp_fix)) {
									case "normal":
										temp = fix + ".value";
										return (eval(temp));
										break;
									case "replace":
										var num = parseInt(val_in);
										temp = fix + ".value";
										return (eval(temp + "[num-1]"));
										break;
									case "split_prefix":
										temp = fix + ".value";
										var temp_sp = eval(temp + ".sp"); /*临时分隔符*/
										var temp_pr = eval(temp + ".pr");
										var temp_str = val_in.replace(new RegExp(temp_sp,"gm"), temp_pr+temp_sp);
										return (temp_str + temp_pr);
										break;
									case "const_st":
										temp = fix + ".value";
										switch (eval(temp)) {
											case "timestamp":
												return timeFormat(val_in);
												break;
										}
								}
							}
						}
					}
					return val_in;
					break;
			}
			return "";
		}
		/*-----------------sql操作相关函数----------------------*/
		function del_lev(id) { /*删除指定行*/
			var data_del = {
				levelId: id
			};
			var del_url =  "/boss/level/deleteLevel";
			var result_del = sup_ajax(del_url, data_del, false);
			if (result_del != null && result_del != "" && result_del.resultCode == 100) {
				/*删除成功*/
				layer.msg("删除成功");
				init_table();
			} else {
				layer.msg("删除失败");
			}
		}

		function up_id(id) { //修改指定行
			init_lab();
			var len = up_table.length;
			var url = "/boss/level/getLevelById";
			
			var data = {
				levelId: id
			};
			var result = sup_ajax(url, data, false);
			/*将数据 进行处理 通过layui框架进行布局渲染*/
			layui.use('table', function() {
				var table = layui.table,
					form = layui.form,
					$ = layui.jquery;
				/*向表格中添加查询到的信息*/
				var common = "result.data.";
				for (var i = 0; i < len; i++) {
					$("#" + up_table[i]).val(eval(common + up_table[i]));
				}
				/*向复选框中添加信息*/
				var checkBox = eval(common + up_table[len - 1]);
				if (checkBox != null && checkBox != "") {
					var checkBoxArray = checkBox.split(",");
					for (var i = 0; i < checkBoxArray.length; i++) {
						$("input[name='price_checkbox']").each(function() {
							if ($(this).attr('title') == checkBoxArray[i]) {
								$(this).attr("checked", "checked");
							}
						})
					}
				}
				layer.open({
					title: '修改信息',
					type: 1,
					content: $('#level-set'),
					shade: false,
					area: ['400px','390px'],
					btn: ['确定', '取消'],
					success: function() {
						form.render(null, 'pop-form');
					},
					cancel:function(index)
					{
						layer.close(index);
						$("#level-set").hide();
					},
					yes: function(index) {
						//确定以后回调函数
						var up_url =  "/boss/level/editLevel";
						/*获取我们查询到的数据  然后根据修改的内容改变这个对象的内容*/
						var up_data = result.data;
						/*这里为了方便 我们将 列表属性的名字和映射表 以及后端回执数据(后端名字不规范 )的名称 保持一致  利用循环进行修改  节省代码*/
						for (var i = 0; i < up_table.length - 1; i++) {
							eval("up_data." + up_table[i] + "=" + "\"" + $("#" + up_table[i]).val() + "\""); /*用用户修改的内容重新定义对象属性*/
						}
						var box_checked = $("input[name='price_checkbox']:checked"); /*选中条数*/
						/*获得复选框的接口*/
						var box_id = ""; /*金额对应的 id*/
						var box_price = ""; /*金额*/
						box_checked.each(function() {
								box_id += $(this).val() + ",";
								box_price += $(this).attr('title') + ",";
							})
							/*这里讲复选框的内容做成以逗号分隔的字符串  不以逗号结尾*/
						box_id = box_id.substring(0, box_id.length - 1);
						box_price = box_price.substring(0, box_price.length - 1);
						/*到此用户的选中的内容就整合完毕了  到时候我会将复选框等组件操作  抽离出来*/
						up_data.fareIds = box_id;
						up_data.farePrice = box_price;
						var up_result = sup_ajax(up_url, up_data, false);
						if (up_result != null && up_result != "" && up_result.resultCode == 100) {
							layer.msg("修改成功");
							init_table();
						} else {
							layer.msg("网络拥塞 请重试！");
						}
						$("#level-set").hide();
						layer.close(index);
					},
					btn2: function() {
						$("#level-set").hide();
					}
				});
			});
		};
		layui.use('table', function() { /*新增 */
			var table = layui.table,
				form = layui.form,
				$ = layui.jquery;
			$("#add-level").on('click', function() {
				init_lab();
				/*获取参数的修改信息*/
				var data_add;
				layer.open({
					title: '新增客户级别设置',
					type: 1,
					content: $('#level-set'),
					shade: false,
					area: ['400px','390px'],
					btn: ['确定', '取消'],
					success: function() {
						form.render(null, 'pop-form');
					},
					cancel:function(index)
					{
						layer.close(index);
						$("#level-set").hide();
					},
					yes: function(index) {
						/*获得复选框的选中信息*/
						var box_checked = $("input[name='price_checkbox']:checked"); /*选中条数*/
						var box_id = ""; /*金额对应的 id*/
						box_checked.each(function() {
								box_id += $(this).val() + ",";
							})
							/*这里讲复选框的内容做成以逗号分隔的字符串  不以逗号结尾*/
						box_id = box_id.substring(0, box_id.length - 1);
						/*拼凑指令*/
						var cmd_add = "data_add ={";
						cmd_add += "\"fareIds\":\"" + box_id + "\","; /*加价金额Id*/
						cmd_add += "\"isDefault\":" + "\"1\","; /*是否默认*/
						for (var i = 0; i < up_table.length - 1; i++) {
							cmd_add += "\"" + up_table[i] + "\" :" + "\"" + $("#" + up_table[i]).val() + "\"";
							if (i < up_table.length - 2) {
								cmd_add += ","; /*去掉最后一行的逗号*/
							}
						}
						cmd_add += "}";
						eval(cmd_add);
						/*调用ajax_sup进行接口调用*/
						var add_url =  "/boss/level/saveLevel";
						var add_result = sup_ajax(add_url, data_add, false);
						/*完成增加以后 隐藏表单*/
						if (add_result != null && add_result.resultCode == 100) {
							layer.msg("添加成功");
						} else {
							layer.msg("添加失败");
						}
						$("#level-set").hide();
						layer.close(index);
						init_table();
					},
					btn2: function() {
						$("#level-set").hide();
					}
				});
			});
			$('.js-search').on('click', function() { /* 搜索 */
				var temp = $("#member-input").val();
				init_table(temp);
			});
			active = {
				reload: function() { /*执行重载*/
					var demoReload = $('#member-input');
					table.reload('idTest', {
						where: {
							id: demoReload.val()
						}
					});
				}
			};
		});
	</script>

</html>